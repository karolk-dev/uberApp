<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <title>Uber Client App</title>

    <!-- Dodaj style Leaflet -->
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            crossorigin=""
    />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <!-- Skrypt Leaflet (JS) -->
    <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            crossorigin=""
    ></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        h1, h2 {
            margin: 10px 0;
        }
        #appContainer {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 90vh;
            display: none; /* na start ukrywamy (przed zalogowaniem) */
        }
        #leftPanel {
            width: 30%;
            min-width: 300px;
            padding: 20px;
            box-sizing: border-box;
            border-right: 1px solid #ccc;
            background-color: #f8f9fa;
        }
        #mapContainer {
            width: 70%;
            height: 100%;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        form {
            margin-bottom: 20px;
        }
        label {
            display: inline-block;
            width: 100px;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="password"], input[type="email"] {
            width: 80%;
            padding: 5px;
            margin-bottom: 10px;
        }
        button {
            margin-top: 10px;
            padding: 10px 15px;
            cursor: pointer;
        }
        .productItem {
            margin: 5px 0;
        }
        .productName {
            font-weight: bold;
        }
        .productPrice {
            margin-left: 10px;
            color: green;
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }

        .notification {
            background: #fff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.error {
            border-color: #f44336;
        }

        .notification.warning {
            border-color: #ff9800;
        }
    </style>
</head>

<body>
<h1>Uber - Client Registration & Login</h1>

<!-- Sekcja rejestracji -->
<div id="registerSection">
    <h2>Rejestracja</h2>
    <form id="registerForm">
        <label for="regName">Username:</label>
        <input type="text" id="regName" required><br>

        <label for="regPassword">Password:</label>
        <input type="password" id="regPassword" required><br>

        <label for="regEmail">Email:</label>
        <input type="email" id="regEmail" required><br>

        <button type="submit">Zarejestruj</button>
    </form>
</div>

<hr>

<!-- Sekcja logowania -->
<div id="loginSection">
    <h2>Logowanie</h2>
    <form id="loginForm">
        <label for="logUsername">Username:</label>
        <input type="text" id="logUsername" required><br>

        <label for="logPassword">Password:</label>
        <input type="password" id="logPassword" required><br>

        <button type="submit">Zaloguj</button>
    </form>
</div>

<!-- Główny interfejs aplikacji, widoczny tylko po zalogowaniu -->
<div id="appContainer">
    <!-- Lewy panel -->
    <div id="leftPanel">
        <h2>Tworzenie przejazdu</h2>
        <form id="rideForm">
            <label for="pickup">Miejsce odbioru:</label>
            <input type="text" id="pickup" placeholder="Np. ul. Marszałkowska 1" required><br>

            <label for="destination">Cel podróży:</label>
            <input type="text" id="destination" placeholder="Np. ul. Długa 10" required><br>

            <h3>Wybierz produkt:</h3>
            <div>
                <input type="radio" id="productUberX" name="product" value="UberX" checked>
                <label for="productUberX">UberX</label>
            </div>
            <div>
                <input type="radio" id="productUberComfort" name="product" value="UberComfort">
                <label for="productUberComfort">UberComfort</label>
            </div>
            <div>
                <input type="radio" id="productUberPets" name="product" value="UberPets">
                <label for="productUberPets">UberPets</label>
            </div>
            <div>
                <input type="radio" id="productUberGreen" name="product" value="UberGreen">
                <label for="productUberGreen">UberGreen</label>
            </div>

            <button type="button" id="checkPriceBtn">Sprawdź ceny</button>
            <button type="submit" id="orderRideBtn">Zamów przejazd</button>
        </form>

        <h3>Ceny produktów:</h3>
        <div class="productItem">
            <span class="productName">UberX:</span>
            <span id="uberXPrice" class="productPrice"></span>
        </div>
        <div class="productItem">
            <span class="productName">UberComfort:</span>
            <span id="uberComfortPrice" class="productPrice"></span>
        </div>
        <div class="productItem">
            <span class="productName">UberPets:</span>
            <span id="uberPetsPrice" class="productPrice"></span>
        </div>
        <div class="productItem">
            <span class="productName">UberGreen:</span>
            <span id="uberGreenPrice" class="productPrice"></span>
        </div>
    </div>

    <!-- Prawa część z mapą -->
    <div id="mapContainer">
        <div id="map"></div>
    </div>
</div>

<script>
    // ------------------- ELEMENTY DOM -------------------
    const registerForm    = document.getElementById('registerForm');
    const loginForm       = document.getElementById('loginForm');
    const registerSection = document.getElementById('registerSection');
    const loginSection    = document.getElementById('loginSection');
    const appContainer    = document.getElementById('appContainer');

    // Formularze i przyciski w aplikacji
    const rideForm      = document.getElementById('rideForm');
    const checkPriceBtn = document.getElementById('checkPriceBtn');

    // Pola ceny produktów
    const uberXPriceField       = document.getElementById('uberXPrice');
    const uberComfortPriceField = document.getElementById('uberComfortPrice');
    const uberPetsPriceField    = document.getElementById('uberPetsPrice');
    const uberGreenPriceField   = document.getElementById('uberGreenPrice');

    // Mapa i jej warstwy
    let map;
    let pickupMarker = null;
    let destinationMarker = null;
    let routePolyline = null;

    // ------------------- FUNKCJA DEKODOWANIA TOKENA -------------------
    function decodeJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (error) {
            console.error("Błąd dekodowania tokena JWT:", error);
            return null;
        }
    }

    // ------------------- FUNKCJA INICJALIZACJI MAPY -------------------
    function initMap() {
        map = L.map('map').setView([52.237049, 21.017532], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);
    }

    // ------------------- FUNKCJA GEOKODOWANIA (Nominatim) -------------------
    async function geocodeAddress(address) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data && data.length > 0) {
                return {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon)
                };
            } else {
                return null;
            }
        } catch (error) {
            console.error("Błąd podczas geokodowania:", error);
            return null;
        }
    }

    // ------------------- OBSŁUGA REJESTRACJI -------------------
    registerForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const username     = document.getElementById('regName').value;
        const password = document.getElementById('regPassword').value;
        const email    = document.getElementById('regEmail').value;

        const data = { username, password, email };

        try {
            const response = await fetch('http://localhost:8080/client-app/api/clients/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('Rejestracja udana:', result);
                alert('Rejestracja zakończona sukcesem!');
            } else {
                const errorText = await response.text();
                console.error('Błąd rejestracji:', errorText);
                alert('Błąd rejestracji: ' + errorText);
            }
        } catch (error) {
            console.error('Błąd podczas rejestracji:', error);
            alert('Wystąpił błąd w trakcie rejestracji.');
        }
    });

    // ------------------- OBSŁUGA LOGOWANIA -------------------
    loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const username = document.getElementById('logUsername').value;
        const password = document.getElementById('logPassword').value;

        const data = { username, password };

        try {
            // Zwróć uwagę na poprawny URL i port do Twojego backendu
            const response = await fetch('http://localhost:8082/client-app/api/clients/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const tokenResponse = await response.json();
                console.log('Logowanie udane. Otrzymany obiekt:', tokenResponse);

                // Dekoduj token i pobierz UUID
                const decodedToken = decodeJwt(tokenResponse.access_token);

                // Walidacja struktury tokena
                if (!decodedToken?.sub) {
                    alert("Nieprawidłowa struktura tokena");
                    return;
                }

                // Zapisz token w localStorage
                localStorage.setItem('accessToken', tokenResponse.access_token);
                localStorage.setItem('clientUuid', decodedToken.sub);

                connectWebSocket(decodedToken.sub);


                alert('Zalogowano pomyślnie. Token zapisany w localStorage.');

                // Ukryj formularze logowania i rejestracji, pokaż główny interfejs
                registerSection.style.display = 'none';
                loginSection.style.display = 'none';
                appContainer.style.display = 'flex';

                // Inicjujemy mapę dopiero teraz, gdy kontener jest widoczny
                initMap();

            } else {
                const errorText = await response.text();
                console.error('Błąd logowania:', errorText);
                alert('Błąd logowania: ' + errorText);
            }
        } catch (error) {
            console.error('Błąd podczas logowania:', error);
            alert('Wystąpił błąd w trakcie logowania.');
        }
    });

    // ------------------- DEKODOWANIE POLYLINE (opcjonalnie) -------------------
    function decodePolyline(encoded) {
        let points = [];
        let index = 0, len = encoded.length;
        let lat = 0, lng = 0;

        while (index < len) {
            let b, shift = 0, result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
            lat += dlat;

            shift = 0;
            result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
            lng += dlng;

            points.push([lat / 1e5, lng / 1e5]);
        }
        return points;
    }

    // Funkcja do łączenia z WebSocket
    function connectWebSocket(clientUuid) {
        const socket = new SockJS('http://localhost:8082/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log('Połączono z WebSocket');

            const subscription = stompClient.subscribe(`/topic/driver-response/${clientUuid}`, (message) => {
                const response = JSON.parse(message.body);
                showNotification(`Kierowca ${response.accepted ? 'zaakceptował' : 'odrzucił'} przejazd!`,
                    response.accepted ? 'success' : 'error');
                if(response.accepted) {
                    // Przekieruj na nową stronę z mapą i czatem
                    localStorage.setItem('driverUuid', response.driverUuid); //new
                    window.location.href = `ride.html?rideId=${response.rideId}`;
                }
            });

            // Obsługa błędów
            socket.onclose = () => {
                console.log('Połączenie WebSocket zamknięte, próba ponownego połączenia...');
                setTimeout(() => connectWebSocket(clientUuid), 5000);
            };
        }, (error) => {
            console.error('Błąd połączenia WebSocket:', error);
        });
    }

    // Funkcja do wyświetlania powiadomień
    function showNotification(message, type = 'success') {
        const container = document.getElementById('notificationContainer');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        container.appendChild(notification);

        // Automatyczne usuwanie po 5 sekundach
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // ------------------- SPRAWDZANIE CEN GET + BEARER TOKEN -------------------
    checkPriceBtn.addEventListener('click', async () => {
        const pickup = document.getElementById('pickup').value;
        const destination = document.getElementById('destination').value;

        // Geokodowanie
        const pickupCoords = await geocodeAddress(pickup);
        const destinationCoords = await geocodeAddress(destination);

        if (!pickupCoords || !destinationCoords) {
            alert("Nie udało się zgeokodować adresów. Sprawdź poprawność wpisanych danych.");
            return;
        }

        // Pobranie tokenu
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert("Brak zapisanego tokenu. Zaloguj się ponownie.");
            return;
        }

        // Czyścimy poprzednie markery/trasy
        if (pickupMarker) map.removeLayer(pickupMarker);
        if (destinationMarker) map.removeLayer(destinationMarker);
        if (routePolyline) map.removeLayer(routePolyline);

        // Dodajemy markery
        pickupMarker = L.marker([pickupCoords.lat, pickupCoords.lon]).addTo(map);
        destinationMarker = L.marker([destinationCoords.lat, destinationCoords.lon]).addTo(map);

        let url = `http://localhost:8080/client-app/api/ride-requests/info` +
            `?pickupLatitude=${pickupCoords.lat}&pickupLongitude=${pickupCoords.lon}` +
            `&destinationLatitude=${destinationCoords.lat}&destinationLongitude=${destinationCoords.lon}`;

        try {
            // Wywołanie GET z Bearer tokenem
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Błąd /info:', errorText);
                alert('Błąd /info: ' + errorText);
                return;
            }

            const rideData = await response.json();
            console.log("Otrzymane dane RideDataInfoDto:", rideData);

            // Ustawiamy przykładowe ceny
            uberXPriceField.textContent       = rideData.uberXPrice       + " PLN";
            uberComfortPriceField.textContent = rideData.uberComfortPrice + " PLN";
            uberPetsPriceField.textContent    = rideData.uberPetsPrice    + " PLN";
            uberGreenPriceField.textContent   = rideData.uberGreenPrice   + " PLN";

            // Rysowanie ewentualnej trasy
            if (rideData.polyline) {
                const decodedPoints = decodePolyline(rideData.polyline);
                routePolyline = L.polyline(decodedPoints, { color: 'blue' }).addTo(map);

                const group = L.featureGroup([pickupMarker, destinationMarker, routePolyline]);
                map.fitBounds(group.getBounds());
            } else {
                const bounds = L.latLngBounds(
                    [pickupCoords.lat, pickupCoords.lon],
                    [destinationCoords.lat, destinationCoords.lon]
                );
                map.fitBounds(bounds);
            }

            // Inne dane, np. ETA, distance
            console.log("ETA:", rideData.eta, "min; distance:", rideData.distance, "m");

        } catch (error) {
            console.error("Błąd w trakcie wywołania /info:", error);
            alert("Wystąpił błąd podczas żądania /info (GET).");
        }
    });

    // ------------------- ZAMÓW PRZEJAZD (POST) -------------------
    rideForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Pobieramy wartości z formularza
        const pickup      = document.getElementById('pickup').value;
        const destination = document.getElementById('destination').value;
        const product     = document.querySelector('input[name="product"]:checked').value;

        // Geokodujemy adresy
        const pickupCoords = await geocodeAddress(pickup);
        const destinationCoords = await geocodeAddress(destination);

        if (!pickupCoords || !destinationCoords) {
            alert("Nie udało się zgeokodować adresów. Sprawdź poprawność wpisanych danych.");
            return;
        }

        // Pobieramy token z localStorage
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert("Brak zapisanego tokenu. Zaloguj się ponownie.");
            return;
        }

        // Tutaj może być potrzebny identyfikator klienta (clientUuid).
        // Jeśli go masz w localStorage lub w tokenie JWT, pobierz go.
        // Dla przykładu hardkodujemy:
        const clientUuid = localStorage.getItem('clientUuid');

        // Budujemy obiekt CreateRideRequestCommand zgodnie z Twoim backendem
        const command = {
            clientUuid: clientUuid,
            pickupLocation: {
                latitude: pickupCoords.lat,
                longitude: pickupCoords.lon
            },
            destinationLocation: {
                latitude: destinationCoords.lat,
                longitude: destinationCoords.lon
            },
            product: "UberX"   // np. "UberX", "UberComfort"
        };

        console.log("Wysyłamy zapytanie createRideRequest:", command);

        // Wysyłamy POST do endpointu z Bearer tokenem
        try {
            const response = await fetch("http://localhost:8080/client-app/api/ride-requests", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(command)
            });

            if (response.status === 201) {
                // Zwraca RideRequestDto w body (według Twojego kodu)
                const rideRequestDto = await response.json();
                showNotification(`Przejazd zamówiony! Oczekiwanie na kierowcę...`, 'info');
                console.log("Otrzymany RideRequestDto:", rideRequestDto);

                alert(`Przejazd zamówiony! \nID: ${rideRequestDto.id} \nStatus: ${rideRequestDto.status}`);
                // Możesz tu także narysować trasę, ustawić widok mapy itp.,
                // jeśli backend zwraca np. polyline w RideRequestDto.

            } else {
                const errorText = await response.text();
                console.error("Błąd zamawiania przejazdu:", errorText);
                alert("Błąd zamawiania przejazdu: " + errorText);
            }

        } catch (error) {
            console.error("Błąd podczas zamawiania przejazdu:", error);
            alert("Wystąpił błąd podczas zamawiania przejazdu.");
        }
    });
</script>
<div id="notificationContainer" class="notification-container"></div>
</body>
</html>
