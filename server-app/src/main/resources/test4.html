<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Testowy Front WebSocket  z Akceptacją/Odrzuceniem</title>

    <!-- Styl Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Biblioteka stomp.js (wersja 2.3.3) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <!-- Skrypt Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .message {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .buttons { margin-top: 10px; }
        button { margin-right: 5px; }
        /* Kontener na mapę */
        #map {
            height: 400px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<h1>Testowy Front WebSocket </h1>
<button id="connectBtn">Połącz</button>
<button id="disconnectBtn" disabled>Rozłącz</button>
<div id="status">Status: Nie połączono</div>

<!-- Kontener na mapę -->
<div id="map"></div>

<h3>Odebrane propozycje przejazdu:</h3>
<div id="messages"></div>

<script>
    // Inicjalizacja mapy Leaflet
    const map = L.map('map').setView([52.2297, 21.0122], 13); // Warszawa - przykładowa lokalizacja

    // Dodanie warstwy kafelkowej OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let client;  // klient STOMP
    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const statusDiv = document.getElementById("status");
    const messagesDiv = document.getElementById("messages");

    // Adres Twojego endpointu WebSocket
    const socketUrl = "ws://localhost:8083/ws-driver";
    // Topic – zastąp UUID drivera właściwym identyfikatorem
    const topic = "/topic/driver/6a020215-23b6-482c-8969-4f276da38fa5";

    // Funkcja dekodująca polyline
    function decodePolyline(encoded) {
        let points = [];
        let index = 0;
        let len = encoded.length;
        let lat = 0;
        let lng = 0;

        while (index < len) {
            let b, shift = 0, result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += dlat;

            shift = 0;
            result = 0;
            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);
            let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += dlng;

            points.push([lat / 1e5, lng / 1e5]);
        }
        return points;
    }

    // Funkcja nawiązująca połączenie i subskrypcję
    function connect() {
        const socket = new WebSocket(socketUrl);
        client = Stomp.over(socket);
        client.debug = null; // wyłączenie logów debug

        client.connect({}, function(frame) {
            statusDiv.textContent = "Status: Połączono (" + frame + ")";
            disconnectBtn.disabled = false;
            connectBtn.disabled = true;
            console.log("Connected: " + frame);

            // Subskrypcja topicu
            client.subscribe(topic, function(message) {
                // Parsujemy otrzymaną wiadomość
                let data;
                try {
                    data = JSON.parse(message.body);
                } catch(e) {
                    console.error("Błąd parsowania JSON:", e);
                    data = message.body;
                }
                console.log("Otrzymano wiadomość:", data);
                displayRideProposal(data);
            });
        }, function(error) {
            statusDiv.textContent = "Status: Błąd połączenia (" + error + ")";
            console.error("Błąd połączenia STOMP:", error);
        });
    }

    // Funkcja rozłączająca klienta
    function disconnect() {
        if (client) {
            client.disconnect(function() {
                statusDiv.textContent = "Status: Rozłączono";
                disconnectBtn.disabled = true;
                connectBtn.disabled = false;
                console.log("Disconnected");
            });
        }
    }

    // Funkcja wyświetlająca propozycję przejazdu oraz przyciski akceptacji/odrzucenia
    function displayRideProposal(proposal) {
        const div = document.createElement("div");
        div.className = "message";

        // Przykładowe wyświetlanie danych
        div.innerHTML = `
            <strong>Ride ID:</strong> ${proposal.rideUuid}<br>
            <strong>Driver UUID:</strong> ${proposal.driverUuid}<br>
            <strong>Pickup:</strong> ${proposal.pickupLocation || "Brak danych"}<br>
            <strong>Dropoff:</strong> ${proposal.dropoffLocation || "Brak danych"}
        `;

        // Jeżeli w obiekcie mamy encodowaną polylinę
        if (proposal.polyline) {
            try {
                const routeCoords = decodePolyline(proposal.polyline);
                // Narysuj trasę na mapie
                const routePolyline = L.polyline(routeCoords, { color: 'blue' }).addTo(map);
                // Dopasuj widok mapy do nowo dodanej polilinii
                map.fitBounds(routePolyline.getBounds());
            } catch (err) {
                console.error("Nie udało się zdekodować polyline:", err);
            }
        }

        // Dodaj przyciski
        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "buttons";

        const acceptBtn = document.createElement("button");
        acceptBtn.textContent = "Akceptuj";
        acceptBtn.addEventListener("click", function() {
            sendRideResponse(proposal.rideUuid, proposal.driverUuid, true);
            div.style.borderColor = "green";
            acceptBtn.disabled = true;
            rejectBtn.disabled = true;
        });

        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "Odrzuć";
        rejectBtn.addEventListener("click", function() {
            sendRideResponse(proposal.rideUuid, proposal.driverUuid, false);
            div.style.borderColor = "red";
            acceptBtn.disabled = true;
            rejectBtn.disabled = true;
        });

        buttonsDiv.appendChild(acceptBtn);
        buttonsDiv.appendChild(rejectBtn);
        div.appendChild(buttonsDiv);

        messagesDiv.appendChild(div);
    }

    // Funkcja wysyłająca odpowiedź przejazdu (akceptacja/odrzucenie)
    function sendRideResponse(rideUuid, driverUuid, accepted) {
        // Endpoint, do którego wysyłasz odpowiedź (z prefiksem /app)
        const responseEndpoint = "/app/driver/ride/response";
        const responsePayload = {
            rideUuid: rideUuid,
            driverUuid: driverUuid,
            accepted: accepted
        };
        // Wysyłamy wiadomość przez STOMP
        client.send(responseEndpoint, {}, JSON.stringify(responsePayload));
        console.log("Wysłano odpowiedź:", responsePayload);
    }

    // Nasłuch przycisków
    connectBtn.addEventListener("click", connect);
    disconnectBtn.addEventListener("click", disconnect);
</script>
</body>
</html>
